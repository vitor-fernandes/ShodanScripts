import json
import requests
import os
import re
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

QUERY = 'http.component:"atlassian jira"'
OUTPUT_FILENAME = "jira_output"
OUTPUT_FILENAME_DOWNLOADED = OUTPUT_FILENAME + ".json.gz"
DECOMPRESSED_FILENAME = OUTPUT_FILENAME + ".json"

jira_hosts = []

def recover_scanned_hosts():
    try:
        with open('scanned_hosts.txt', 'r') as host:
            for i in host.readlines():
                jira_hosts.append(i.rstrip("\n"))
    except Exception as e:
        print(e)

def download_data_from_Shodan(query):
    result = os.system('shodan download --limit -1 {} {}'.format(OUTPUT_FILENAME, query))
    if(result != 0):
        return False
    return True

def decompress_data(filename):
    result = os.system('gzip -d {}'.format(filename))
    if(result != 0):
        return False
    return True

def load_results(filename):
    results = []
    hosts = open(filename, 'r')
    
    for host in hosts.readlines():
        results.append(json.loads(host))
    
    return results

def prepare_data():
    """
    data = ""
    if(download_data_from_Shodan(QUERY)):
        if(decompress_data(OUTPUT_FILENAME_DOWNLOADED)):
            data = load_results('jira_output.json')
        else:
            print('error')
    else:
        print('error')
    """
    recover_scanned_hosts()
    data = load_results('jira_output.json')
    hosts = extract_hosts(data)
    formated_hosts = format_hosts(hosts)
    
    return formated_hosts

def extract_hosts(all_data):
    hosts = {}

    host_list = []
    http_ports = []

    for data in all_data:
        ports = []

        if(type(data['data']) == list):
            for i in range(len(data['data'])):
                ports.append(data['data'][i]['port'])
   
        else:
            ports.append(data['port'])


        host_list.append(data['ip_str'])
        http_ports.append(ports)

                
    hosts['ip_str'] = host_list
    hosts['ports'] = http_ports

    return hosts

def format_hosts(hosts):
    all_hosts = hosts

    formated_hosts = []

    for i in range(len(all_hosts['ip_str'])):
        host = ""
        if(len(all_hosts['ports'][i]) > 1):
            for port in all_hosts['ports'][i]:
                if(port != 443):
                    host += "http://" + all_hosts['ip_str'][i] + ":" + str(port)
                else:
                    host += "https://" + all_hosts['ip_str'][i] + ":" + str(port)

        else:
            if(all_hosts['ports'][i][0] != 443):
                host += "http://" + all_hosts['ip_str'][i] + ":" + str(all_hosts['ports'][i][0])
            
            else:
                host += "https://" + all_hosts['ip_str'][i] + ":" + str(all_hosts['ports'][i][0])
            
        formated_hosts.append(host)

    return formated_hosts

def extract_hostname(response_body):
    hostname = ""

    try:
        REGEX_HOSTNAME = 'class="aui-header-logo aui-header-logo-custom"><a href="'

        t = re.search(REGEX_HOSTNAME, response_body)

        span = t.span()

        hostname = response_body[span[1]:].split("\"")[0]
    
    except Exception as e:
        print("Erro: {}".format(e))

    return hostname

def verify_ContactAdministrators_page(host):
    url = ""
    
    if(host[-1] == "/"):
        url = host + "ContactAdministrators!default.jspa"
    else:
        url = host + "/../ContactAdministrators!default.jspa"
    
    try:
        request = requests.get(url, verify=False, allow_redirects=True, timeout=5)
        if('name="subject"' in request.text):
            return True

        else:
            return False

    except Exception as e:
        print("Error: {}".format(e))


def save(text):
    os.system('echo "Host: {} | Domain: {}" >> vulnerables_output.txt'.format(text[0], text[1]))

def verify_jira(host):

    if(host in jira_hosts):
        return 
    else:
        try:
            os.system('echo "{}" >> scanned_hosts.txt'.format(host))
            print(host)
            request = requests.get(host, verify=False, allow_redirects=True, timeout=5)
            jira_hosts.append(host)

            if('name="atlassian-token"' in request.text):

                if(verify_ContactAdministrators_page(request.url)):
                    hostname = extract_hostname(request.text)
                    print("Host: {} have the Contact Page Habilited | Domain: {}".format(host, hostname))
                    save((host, hostname))
                    
                print("Not Vulnerable")

        except Exception as e:
            print("Error: {}".format(e))



def main():
    all_hosts = prepare_data()
    for host in all_hosts:
        verify_jira(host)

main()